workflows:
  ios_release:
    name: iOS Release (verbose upload)
    instance_type: mac_mini_m2
    max_build_duration: 60

    environment:
      flutter: 3.29.2
      xcode: 16.4
      cocoapods: default
      # ë„¤ ì•± ë²ˆë“¤ ID í™•ì¸í•´ì„œ í•„ìš” ì‹œ ìˆ˜ì •
      vars:
        BUNDLE_ID: com.zlabo.wonmoremoneybook

    cache:
      cache_default_paths: true

    # ====== ë¹Œë“œ ìˆœì„œ ======
    scripts:
      # 1) ì„œëª… íŒŒì¼ ìë™ ì¤€ë¹„ (í”„ë¡œíŒŒì¼/ì¸ì¦ì„œ ìƒì„±Â·ë‹¤ìš´ë¡œë“œ + Xcode í”„ë¡œì íŠ¸ì— ì ìš©)
      - name: Prepare iOS code signing
        script: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create
          keychain add-certificates
          xcode-project use-profiles

      # 2) Flutterë¡œ "ì•± IPA" ìƒì„± (Runner.appì´ ë“¤ì–´ìˆëŠ” ì •ìƒ IPA)
      - name: Flutter build IPA (App Store export)
        script: |
          flutter clean
          flutter pub get
          : "${BUILD_NUMBER:=1}"
          # xcode-project use-profilesê°€ ë§Œë“¤ì–´ ë‘” export_options.plist ì‚¬ìš©
          flutter build ipa --release \
            --build-number=$BUILD_NUMBER \
            --export-options-plist $HOME/export_options.plist

      # 3) IPA êµ¬ì¡° í™•ì¸ + App Store Connectì— --verboseë¡œ ì—…ë¡œë“œ
      - name: Publish to App Store Connect (verbose)
        script: |
          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬
          : "${APP_STORE_CONNECT_KEY_ID:?Set APP_STORE_CONNECT_KEY_ID in Environment variables}"
          : "${APP_STORE_CONNECT_ISSUER_ID:?Set APP_STORE_CONNECT_ISSUER_ID in Environment variables}"
          : "${APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY:?Set APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY (multiline)}"

          # IPA ì°¾ê¸°
          IPA="$(/usr/bin/find "$PWD" -type f -name '*.ipa' -print -quit || true)"
          [ -n "$IPA" ] || IPA="$(/usr/bin/find /Users/builder -type f -name '*.ipa' -print -quit || true)"
          [ -f "$IPA" ] || { echo "âŒ IPA not found"; exit 1; }
          echo "âœ… Found IPA: $IPA"

          echo "ğŸ“¦ IPA contents (first lines):"
          unzip -l "$IPA" | sed -n '1,120p' || true

          # .appì˜ Info.plistë§Œ í™•ì¸
          TMP_DIR="$(mktemp -d)"
          unzip -q "$IPA" -d "$TMP_DIR"
          PLIST="$(find "$TMP_DIR/Payload" -type f -path '*/.app/Info.plist' | head -1 || true)"
          if [ -z "$PLIST" ]; then
            echo "âŒ App .app/Info.plist not found. This is NOT a valid app IPA."
            exit 2
          fi
          echo "â„¹ï¸ From App Info.plist:"
          /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$PLIST" || true
          /usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$PLIST" || true
          /usr/libexec/PlistBuddy -c 'Print :CFBundleVersion' "$PLIST" || true

          # ì—…ë¡œë“œ (ìì„¸í•œ ì‹¤íŒ¨ ì›ì¸ ë³´ê¸° ìœ„í•´ --verbose)
          app-store-connect publish \
            --path "$IPA" \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --private-key @env:APP_STORE_CONNECT_PUBLISHER_PRIVATE_KEY \
            --verbose

    # ì‚°ì¶œë¬¼ ë³´ê´€
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/ipa/*.dSYM.zip

    # ê¸°ë³¸ í¼ë¸”ë¦¬ì…”ëŠ” ë”(ì¤‘ë³µ ì—…ë¡œë“œ ë°©ì§€) â€” ìš°ë¦¬ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì—…ë¡œë“œí•¨
    publishing:
      app_store_connect:
        submit_to_testflight: false
        submit_to_app_store: false
